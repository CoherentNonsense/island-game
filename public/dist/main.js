(()=>{"use strict";function e(e){const t=(e-1)%4;return 3-(t<0?t+4:t)}class t{constructor(e=null){this._serverPacket=!!e,this._data=this._serverPacket?e:new ArrayBuffer(400),this._length=0}data(){return this._length+=e(this._length),this._data.slice(0,this._length)}writeNumber(t){if(this._serverPacket)return new Error("Cannot write to a server packet");const a=new Int32Array(this._data);return this._length+=e(this._length),a[this._length/4]=t,this._length+=4,this}writeString(e){if(this._serverPacket)return new Error("Cannot write to a server packet");if(e.length>255)return new Error("Cannot write a string larger than 255 characters");const t=new Uint8Array(this._data);t[this._length]=e.length,this._length+=1;for(let a=0;a<e.length;++a)t[this._length]=e.charCodeAt(a),this._length+=1;return this}readNumber(){if(!this._serverPacket)return new Error("Cannot read from a client packet.");const t=new Int32Array(this._data);this._length+=e(this._length);const a=t[this._length/4];return this._length+=4,a}readString(){if(!this._serverPacket)return new Error("Cannot read from a client packet");const e=new Uint8Array(this._data);let t="";const a=e[this._length];this._length+=1;for(let r=0;r<a;++r)t+=String.fromCharCode(e[this._length]),this._length+=1;return t}}const a=Object.freeze({Dummy:Symbol("symbol"),SandFlea:Symbol("sandflea"),Tumps:Symbol("tumps")}),r={[a.Dummy]:{name:"dummy",health:5,attacks:[{flavour:["The dummy stands","menacingly"],damage:0,speed:0}],gold:0},[a.SandFlea]:{name:"sandflea",health:4,gold:2,attacks:[{flavour:["The sandflea hits","you for %","dmg"],damage:2,speed:100}]}},s=[a.Dummy,a.SandFlea];let n={},i={},o={};s.forEach(((e,t)=>{n[e]=t,i[e.name]=t,o[t]=e}));const c=Object.freeze({Start:Symbol("start"),Dummies:Symbol("dummies"),TutPort:Symbol("tutport"),CrossRoad:Symbol("crossroad"),Statue:Symbol("statue"),Trees:Symbol("trees"),ForestN:Symbol("forestN"),ForestS:Symbol("forestS"),Dungeon:Symbol("dungeon"),TundraS:Symbol("tundraS"),TundraN:Symbol("tundraN"),Cave:Symbol("cave"),Grasslands:Symbol("grasslands"),Campfire:Symbol("campfire"),Ice:Symbol("ice"),CitySm:Symbol("CitySm"),CityMd:Symbol("CityMd"),CityLg:Symbol("CityLg"),Tower:Symbol("tower")}),l={[c.Start]:{position:[22,142],players:[]},[c.Dummies]:{position:[14,126],players:[]},[c.TutPort]:{position:[46,129],players:[]},[c.CityLg]:{position:[101,140],players:[]},[c.CrossRoad]:{position:[122,132],players:[]},[c.Statue]:{position:[117,119],players:[]},[c.CityMd]:{position:[142,112],players:[]},[c.Trees]:{position:[88,118],players:[]},[c.ForestN]:{position:[115,78],players:[]},[c.ForestS]:{position:[105,97],players:[]},[c.Dungeon]:{position:[83,69],players:[]},[c.TundraS]:{position:[65,43],players:[]},[c.TundraN]:{position:[86,18],players:[]},[c.Cave]:{position:[25,36],players:[]},[c.Grasslands]:{position:[41,88],players:[]},[c.Campfire]:{position:[12,70],players:[]},[c.Ice]:{position:[123,26],players:[]},[c.CitySm]:{position:[69,101],players:[]},[c.Tower]:{position:[113,49],players:[]}};function u(e,t){l[t].players.includes(e)||l[t].players.push(e)}function h(e){w.forEach((t=>{l[t].players=l[t].players.filter((t=>e!==t))}))}function m(e){let t=null;return w.forEach(((a,r)=>{l[a].players.includes(e)&&(t=y[r])})),t}const d={[c.Start]:[c.Start,c.Dummies,c.TutPort],[c.Dummies]:[c.Dummies,c.Start,c.TutPort],[c.TutPort]:[c.TutPort,c.Dummies,c.Start],[c.CrossRoad]:[c.CrossRoad,c.CityLg,c.Statue,c.CityMd],[c.Statue]:[c.Statue,c.CrossRoad,c.Trees,c.ForestS],[c.CityLg]:[c.CityLg,c.CrossRoad],[c.CityMd]:[c.CityMd,c.CrossRoad,c.ForestS],[c.Trees]:[c.Trees,c.Statue,c.CitySm,c.ForestS],[c.ForestN]:[c.ForestN,c.ForestS,c.Dungeon],[c.ForestS]:[c.ForestS,c.ForestN,c.CitySm,c.Statue,c.Trees,c.CityMd],[c.Dungeon]:[c.Dungeon,c.ForestN,c.TundraS],[c.TundraS]:[c.TundraS,c.TundraN,c.Dungeon],[c.TundraN]:[c.TundraN,c.TundraS,c.Ice],[c.Cave]:[c.Cave,c.Campfire],[c.Grasslands]:[c.Grasslands,c.Campfire,c.CitySm],[c.Campfire]:[c.Campfire,c.Grasslands,c.Cave],[c.Ice]:[c.Ice,c.Tower,c.TundraN],[c.CitySm]:[c.CitySm,c.Grasslands,c.Trees],[c.Tower]:[c.Tower,c.Ice]},w=[c.Start,c.Dummies,c.TutPort,c.CrossRoad,c.Statue,c.CityLg,c.CityMd,c.Trees,c.ForestN,c.ForestS,c.Dungeon,c.TundraS,c.TundraN,c.Cave,c.Grasslands,c.Campfire,c.Ice,c.CitySm,c.Tower];let p={},y={};w.forEach(((e,t)=>{p[e]=t,y[t]=e}));const g=Object.freeze({Hands:Symbol("hands"),Spear:Symbol("spear"),IceBreath:Symbol("ice_breath"),FireBreath:Symbol("fire_breath"),WaterBreath:Symbol("water_breath"),IceSword:Symbol("ice_sword"),FireSword:Symbol("fire_sword"),WaterSword:Symbol("water_sword"),IceCream:Symbol("ice_cream"),Heart:Symbol("heart"),MaxHeal:Symbol("max_heal")}),b={[g.Hands]:{name:"hands",damage:2,speed:1},[g.Spear]:{name:"spear",damage:3,speed:8,price:1,desc:["A light wooden","spear with its","end whittled to","a point"]},[g.IceBreath]:{name:"ice breath",damage:1,speed:20,special:"freeze",price:1,desc:["Spell:","Freeze your","enemies"]},[g.FireBreath]:{name:"fire breath",damage:1,speed:20,special:"burn",price:1},[g.WaterBreath]:{name:"water breath",damage:2,speed:20,special:"soak",price:1},[g.IceSword]:{name:"ice sword",damage:9,speed:15,type:"ice",price:1,desc:["A sword made","from vibrant","blue ice"]},[g.FireSword]:{name:"fire sword",damage:9,speed:9,type:"fire",price:1},[g.WaterSword]:{name:"water sword",damage:9,speed:10,type:"water",price:1},[g.IceCream]:{name:"ice cream",heal:!0,damage:10,speed:5,price:1,desc:["I scream","you scream","Heal 10"]},[g.Heart]:{name:"heart",heal:!0,damage:20,speed:8,price:1,desc:["ew","Heal 20"]},[g.MaxHeal]:{name:"ice cream",heal:!0,damage:50,speed:1,price:1,desc:["Heal 50"]}},f=[g.Hands,g.Spear];let k={},S={};f.forEach(((e,t)=>{k[e]=t,S[t]=e}));class M{constructor(e,t,a=(()=>{})){this.name=e,this.to=t,this.onclick=a}}class C{constructor(e,t={}){this.options=e,this.message=t.message||[],this.inputMode=t.inputMode||!1,this.inputLine=t.inputLine||5,this.dontClearMessages=t.dontClearMessages||!1}}class v{constructor(e,a={}){this.submenus=e,this.index=0,this.root=Object.keys(this.submenus)[0],this.current=this.root,this.messages=[...this.submenus[this.current].message],this.inputMode=!1,this.inputLine=0,this.input="",this.notification=!1,this.talking=[],this.defaultImg=a.img||this.current.toLowerCase(),this.defaultAnim=a.anim,this.defaultAnimSpeed=a.animSpeed||.003,this.talkingMode=a.talkingMode||!1,this.location=a.location,this.freeRoam=void 0===a.freeRoam||a.freeRoam,this.currentCommand="";const r=new M("Stats","stats");if(this.submenus.stats=new C([new M("Player","",(e=>{this.messages=[`Hp: ${e.health}/${e.maxHealth}`],this.pushMessage(`Gold: ${e.gold}`)})),new M("Equip","equip",(e=>{this.messages=["Weapons:"],e.items.forEach((e=>{this.pushMessage(b[e].name)}))})),new M("Back",this.root)]),this.submenus.equip=new C([new M("Use","use"),new M("Delete","delete"),new M("Back","stats")],{dontClearMessages:!0}),this.submenus.use=new C([new M("Use 1","stats",(e=>e.items[0].use(e))),new M("Use 2","stats",(e=>e.items[1].use(e))),new M("Use 3","stats",(e=>e.items[2].use(e))),new M("Use 4","stats",(e=>e.items[3].use(e))),new M("Back","equip")],{dontClearMessages:!0}),this.submenus.delete=new C([new M("Del 1","stats",(e=>e.items.splice(0,1))),new M("Del 2","stats",(e=>e.items.splice(1,1))),new M("Del 3","stats",(e=>e.items.splice(2,1))),new M("Del 4","stats",(e=>e.items.splice(3,1))),new M("Back","equip")],{dontClearMessages:!0}),"combat"!==this.current&&"title"!==this.current&&this.submenus[this.current].options.splice(this.submenus[this.current].options.length-1,0,r),!a.disableTalk){const e=new M("Talk","talk",(e=>{e.talkTutorial&&(e.talkTutorial=!1,this.talk("/help for info")),this.notification=!1}));"combat"===this.current?this.submenus[this.current].options.push(e):this.submenus[this.current].options.splice(this.submenus[this.current].options.length-1,0,e),this.submenus.talk=new C([new M("Speak","",(e=>{const a=this.input.trimEnd();if(a.startsWith("/")){const r=a.split(" ");switch(this.currentCommand=r[0],this.talk(""),r[0]){case"/help":r[1]?"party"===r[1]?(this.talk(String.fromCharCode(218)+"Make a party"+String.fromCharCode(191)),this.talk("/make [password]"),this.talk(String.fromCharCode(218)+"Join a party"+String.fromCharCode(191)),this.talk("/join [password]"),this.talk("/next (next page)")):"talk"===r[1]&&(this.talk(String.fromCharCode(218)+"Global Chat"+String.fromCharCode(191)),this.talk("unimplemented")):(this.talk(String.fromCharCode(218)+"Commands"+String.fromCharCode(191)),this.talk("/what (is this?)"),this.talk("/help party"),this.talk("/help talk"));break;case"/what":this.talk("This screen lets"),this.talk("you to talk to"),this.talk("people nearby or"),this.talk("enter commands");break;case"/next":this.talk(String.fromCharCode(218)+"Leave party"+String.fromCharCode(191)),this.talk("/leave"),this.talk(String.fromCharCode(218)+"List members"+String.fromCharCode(191)),this.talk("/list");break;case"/make":{if(e.partyPassword.length>0){this.talk("/leave current"),this.talk("party first");break}if(!r[1]){this.talk("Enter a password");break}e.partyPassword=r[1],e.isPartyLeader=!0,e.partyLeader=e.id,e.individualMaxHealth=e.maxHealth,e.individualHealth=e.health,this.talk("Party Password:"),this.talk(e.partyPassword);const a=(new t).writeNumber(7).writeString(e.partyPassword);e.client.sendPacket(a);break}case"/join":{if(e.partyPassword.length>0){this.talk("/leave current"),this.talk("party first");break}if(!r[1]){this.talk("Enter a password");break}const a=(new t).writeNumber(6).writeString(r[1]).writeNumber(e.id).writeNumber(e.maxHealth).writeNumber(e.health);e.client.sendPacket(a),e.waitingPartyPassword=r[1],this.talk("Joining...");break}case"/leave":{if(0===e.partyPassword.length){this.talk("You are not in a"),this.talk("party");break}if(e.isPartyLeader&&e.party.length>1){e.isPartyLeader=!1;const a=(new t).writeNumber(10).writeNumber(e.id).writeNumber(e.party[1]);e.client.sendPacket(a)}const a=(new t).writeNumber(9).writeNumber(e.id).writeNumber(e.individualMaxHealth).writeNumber(e.individualHealth);e.client.sendPacket(a),e.partyPassword="",e.waitingPartyPassword="",e.party=[e.id];const r=e.health/e.maxHealth,s=Math.ceil(r*e.individualMaxHealth);e.maxHealth=e.individualMaxHealth,e.health=s,this.talk("Left party");break}case"/list":this.talk(String.fromCharCode(218)+"Members (IDS)"+String.fromCharCode(191));const a=Math.min(4,e.party.length);for(let t=0;t<a;++t)this.talk(""+e.party[t]);break;default:this.talk("Invalid command")}}else a.length>0&&(e.isOffline||e.client.sendPacket((new t).writeNumber(5).writeNumber(e.id).writeString(a)),this.talk(a));this.input=""})),new M("Back",this.current)],{inputMode:!0})}}currentOptions(){return this.submenus[this.current].options}currentMessages(){return this.talkingMode||"talk"===this.current?this.talking:this.messages}reset(){this.current=this.root,this.messages=[...this.submenus[this.current].message]}moveUp(){this.index>0&&(this.index-=1)}moveDown(){this.index<this.currentOptions().length-1&&(this.index+=1)}talk(e){"talk"!==this.current&&"combat"!==this.root&&(this.notification=!0),this.talking.push(e),this.talking.length>5&&this.talking.splice(0,1)}pushMessage(e){this.messages.push(e),this.messages.length>5&&this.messages.splice(0,1)}select(e,t){if(t)this.current=t;else{const t=this.currentOptions()[this.index];if(!1===t.onclick(e))return;if(""===t.to)return;if("leave"===t.to)return void(e.partyPassword.length>0&&!e.isPartyLeader?(this.pushMessage("Wait for party"),this.pushMessage("leader")):e.state=j.Map);this.current=t.to}this.index=0,this.input="";const a=this.submenus[this.current];a.dontClearMessages||(this.messages=[...a.message]),this.talkingMode&&a.message.forEach((e=>this.talk(e))),this.inputMode=a.inputMode,this.inputLine=a.inputLine}drawDisplay(e,t){this.defaultAnim?e.drawAnim(this.defaultAnim,0,0,80,80,0,0,t,this.defaultAnimSpeed):this.defaultImg&&e.draw(this.defaultImg,0,0,80,80,0,0),this.location&&l[this.location].players.length>1&&!this.submenus[this.current].img&&e.draw("other",0,0,80,80,0,0)}}const L=new v({title:new C([new M("Offline","username",(e=>e.isOffline=!0)),new M("Host","host"),new M("Join","join"),new M("Credits","credits")],{message:["Controls","Up/Down Arrows","Enter"]}),host:new C([new M("Create","username",(e=>{const t=e.currentMenu.input.trim();if(0===t.length)return e.currentMenu.pushMessage("Please enter a"),e.currentMenu.pushMessage("host ID"),!1;e.isHost=!0,e.hostId=t})),new M("Back","title")],{message:["Create Host ID","for others to","join"],inputMode:!0}),join:new C([new M("Join","username",(e=>{const t=e.currentMenu.input.trim();if(0===t.length)return e.currentMenu.pushMessage("Please enter a"),e.currentMenu.pushMessage("host ID"),!1;e.isHost=!1,e.hostId=t})),new M("Back","title")],{message:["Join Host ID",'Main Server: "0"'],inputMode:!0}),username:new C([new M("Enter","",(async e=>{const a=e.currentMenu.input.trim();if(0===a.length)return e.currentMenu.pushMessage("Please enter a"),void e.currentMenu.pushMessage("username");if(e.username=a,e.isOffline)e.party=[0];else{await e.client.start("ws://localhost:8080");let a=new t;e.isHost?a.writeNumber(0).writeString(e.hostId):a.writeNumber(1).writeString(e.hostId),e.client.sendPacket(a)}e.state=j.Intro,e.currentLocation=c.Start,e.screenAnimStart=e.time})),new M("Back","title")],{message:["Enter username"],inputMode:!0}),credits:new C([new M("Back","title")],{message:["Made by:","CoherentNonsense","","","Font:","Taffer"]})},{anim:"title",disableTalk:!0});function N(e,t){const a=b[t];a.price>e.gold?(e.currentMenu.messages=["Can't afford"],e.currentMenu.pushMessage(`You have ${e.gold}g`)):e.items.length>4?(e.currentMenu.messages=["Too many items"],e.currentMenu.pushMessage("Remove one first"),e.currentMenu.pushMessage("(Go to stats)")):(e.currentMenu.messages=["Bought"],e.gold-=a.price,e.items.push(t))}const P=new v({start:new C([new M("Leave","leave")],{message:["You stand at the","tip of an island"]})},{location:c.Start}),T=new v({dummies:new C([new M("Fight","",(e=>e.enterCombat(a.Dummy))),new M("Leave","leave")],{message:["A pair of","fighting dummies","are loosely held","in the sand"]})},{location:c.Dummies}),x=new v({tutPort:new C([new M("Boat","boat"),new M("Leave","leave")],{message:["A port with some","boats docked.","How convenient","You can see a","city across the","water"]}),boat:new C([new M("Go","",(e=>{e.currentMenu=H,e.currentLocation=c.CityLg,e.client.sendPacket((new t).writeNumber(4).writeNumber(e.id)),h(e.id),e.client.sendPacket((new t).writeNumber(3).writeNumber(e.id).writeNumber(p[e.currentLocation])),u(e.id,e.currentLocation),e.currentMenu.reset()})),new M("Stay","tutPort")],{message:["Are you sure?","You wont be able","to return here"]})},{location:c.TutPort,freeRoam:!1}),H=new v({cityLg:new C([new M("Alley","alley"),new M("Leave","leave")],{message:["Massive buildings","tower over you.","This seems like","a large city","yet the streets","are empty"]}),alley:new C([new M("Weapons","weapons"),new M("Food","food"),new M("Back","cityLg")],{message:["Many vendors fill","the cracks within","the buildings","passing out goods","from the shadows"]}),weapons:new C([new M("Spear","spear"),new M("I.Sword","ice_sword"),new M("I.Breth","ice_breath"),new M("Back","alley")]),food:new C([new M("I.Cream","ice_cream"),new M("Heart","heart"),new M("Mx.Heal","max_heal")]),spear:new C([new M(`Buy ${b[g.Spear].price}g`,"weapons",(e=>N(e,g.Spear))),new M("Back","weapons")],{message:b[g.Spear].desc}),ice_sword:new C([new M(`Buy ${b[g.IceSword].price}g`,"weapons",(e=>N(e,g.IceSword))),new M("Back","weapons")],{message:b[g.IceSword].desc}),ice_breath:new C([new M(`Buy ${b[g.IceBreath].price}g`,"weapons",(e=>N(e,g.IceBreath))),new M("Back","weapons")],{message:b[g.IceBreath].desc}),ice_cream:new C([new M(`Buy ${b[g.IceCream].price}g`,"food",(e=>N(e,g.IceCream))),new M("Back","food")],{message:b[g.IceCream].desc}),heart:new C([new M(`Buy ${b[g.Heart].price}g`,"food",(e=>N(e,g.Heart))),new M("Back","food")],{message:b[g.Heart].desc}),max_heal:new C([new M(`Buy ${b[g.MaxHeal].price}g`,"food",(e=>N(e,g.MaxHeal))),new M("Back","food")],{message:b[g.MaxHeal].desc})},{location:c.CityLg}),I=new v({crossroads:new C([new M("Leave","leave")],{message:["A fork in the","road"]})},{location:c.CrossRoad}),_=new v({statue:new C([new M("Leave","leave")],{message:["A statue stands","proudly on its","marble slab"]})},{location:c.Statue}),A=(new v({trees:new C([new M("Leave","leave")],{message:["A patch of trees","scattered in","the grass"]})},{location:c.Trees}),new v({cityMd:new C([new M("Leave","leave")],{message:["A statue stands","proudly on its","marble slab"]})},{location:c.CityMd})),D=new v({citySm:new C([new M("Leave","leave")],{message:["Sorry:","Closed for time"]})},{location:c.CitySm}),B=new v({grasslands:new C([new M("Leave","leave")],{message:["Hills of grass","as far as one can","see"]})},{location:c.Grasslands}),E=new v({campfire:new C([new M("Leave","leave")],{message:["Some logs sit","around a burning","campfire"]})},{location:c.Campfire}),R=new v({cave:new C([new M("Leave","leave")],{message:["Sorry:","Closed for time"]})},{location:c.Cave}),F=new v({forestS:new C([new M("Leave","leave")],{message:["Sorry:","Closed for time"]})},{location:c.ForestS}),$=new v({forestN:new C([new M("Leave","leave")],{message:["Sorry:","Closed for time"]})},{location:c.ForestN}),O=new v({dungeon:new C([new M("Leave","leave")],{message:["Sorry:","Closed for time"]})},{location:c.Dungeon}),W=new v({tundras:new C([new M("Leave","leave")],{message:["Sorry:","Closed for time"]})},{location:c.TundraS}),G=new v({tundran:new C([new M("Leave","leave")],{message:["Sorry:","Closed for time"]})},{location:c.TundraN}),z=new v({ice:new C([new M("Leave","leave")],{message:["Sorry:","Closed for time"]})},{location:c.Ice}),U=new v({tower:new C([new M("Leave","leave")],{message:["Sorry:","Closed for time"]})},{location:c.Tower}),Y={[c.Start]:P,[c.Dummies]:T,[c.TutPort]:x,[c.CityLg]:H,[c.CrossRoad]:I,[c.Trees]:I,[c.Statue]:_,[c.CityMd]:A,[c.CitySm]:D,[c.ForestN]:$,[c.ForestS]:F,[c.Grasslands]:B,[c.TundraN]:G,[c.TundraS]:W,[c.Campfire]:E,[c.Cave]:R,[c.Dungeon]:O,[c.Ice]:z,[c.Tower]:U},j=Object.freeze({Intro:Symbol("intro"),Map:Symbol("map"),Travel:Symbol("travel"),Combat:Symbol("combat"),Location:Symbol("location")}),q={isOffline:!1,isHost:!1,id:-1,hostId:"",client:new class{constructor(){this.isHost=!1,this.players=[],this.incomingMessages=[]}start(e){if(!this.socket||this.socket.readyState===this.socket.CLOSED)return this.incomingMessages=[],this.socket=new WebSocket(e),this.socket.binaryType="arraybuffer",this.socket.onmessage=e=>{this._handleMessage(e)},this.socket.onerror=()=>{this._reconnect},this.socket.onclose=()=>{this._reconnect},new Promise((e=>{this.socket.onopen=()=>{e()}}))}hostGame(e){this.isHost=!0}joinGame(e){this.isHost=!1}pollIncomingPackets(e){for(;0!==this.incomingMessages.length;)e(this.incomingMessages.shift())}closeGame(){this.isHost}sendPacket(e){this.socket&&this.socket.readyState===this.socket.OPEN&&this.socket.send(e.data())}_handleMessage(e){const a=new t(e.data);this.incomingMessages.push(a)}_reconnect(){console.log("Attempting to reconnect to the server")}},time:0,state:j.Location,currentMenu:L,username:"",maxHealth:15,health:15,gold:100,party:[],isPartyLeader:!1,partyLeader:-1,partyPassword:"",waitingPartyPassword:"",partyEnemySelection:{},individualHealth:0,individualMaxHealth:0,partyIndividualHealth:{},talkTutorial:!0,mapTutorial:!0,deathTutorial:!0,weather:"Summer",changeRequest:!1,lastCity:c.CityLg,inLocation:!1,currentLocation:null,locationSelected:0,items:[],screenAnimStart:0,screenAnimType:"",enemy:{},attackSelection:[],inCombat:!1,attackTimer:0,combatMenu:null,enterCombat:e=>K(e,0)};function J(e,t,a){if(e.fillRect("#080808",0,80,160,80),a.currentOptions().forEach(((t,r)=>{const s=t.name;let n="Talk"===s&&a.notification?"!":" ";n="Leave"===s&&q.partyPassword.length>0&&!q.isPartyLeader?String.fromCharCode(42):n,n=r===a.index?">":n,e.drawText(83,2+13*r,n+s)})),a.currentMessages().forEach(((t,a)=>{e.drawText(3,83+13*a,t)})),a.drawDisplay(e,t),!a.inputMode)return;let r=Math.floor(.002*t)%2;17===a.input.length&&(r=0),e.drawText(3,83+13*a.inputLine,a.input+(1===r?String.fromCharCode(179):""))}function K(e,a){if(q.isPartyLeader){const a=(new t).writeNumber(13).writeNumber(q.id).writeNumber(n[e]);q.client.sendPacket(a)}q.enemy={...r[e]},q.enemy.maxHealth=q.enemy.health;const s=q.state===j.Map?[(i=q.enemy.name,["a","e","i","o","u"].includes(i[0])?`An ${i}`:`A ${i}`),"attacks on your","way!"]:["You attack the",q.enemy.name];var i;const o=((e,a)=>{const r=[],s=[...e.items];0===s.length&&s.push(g.Hands),s.forEach((a=>{const s=b[a];r.push(new M(s.name,"wait",(()=>{let r=s.damage+(Math.floor(3*Math.random())-1);e.attackSelection.push({...s,damage:r,username:e.username,type:"attack"});const n=(new t).writeNumber(14).writeNumber(e.partyLeader).writeString(e.username).writeNumber(k[a]).writeNumber(r);e.client.sendPacket(n)})))})),r.push(new M("Back","combat"));const n=new v({combat:new C([new M("Attack","attack")]),attack:new C(r,{dontClearMessages:!0}),wait:new C([],{message:["Waiting..."]}),win:new C([new M("Cont.","",(e=>e.state=j.Location))],{message:["","You Win!",`You gained ${e.enemy.gold}g`]}),lose:new C([new M("Cont.","",(e=>{e.state=j.Location,e.currentLocation=e.lastCity,e.currentMenu=Y[e.currentLocation],e.deathTutorial&&(alert("-- Epic Tutorial Below --When you die, you will respawn at the last town you visited. You keep everything but your gold.\n\nP.S. Bunch of information added to the itch.io page that I couldn't tutorialise"),e.deathTutorial=!1),e.gold=0}))],{message:["","You Died ):",`Lost ${e.gold}g`]})},{img:e.enemy.name.replace(" ","_"),talkingMode:!0});return a.forEach((e=>{n.talk(e)})),n})(q,s);q.combatMenu=o,q.state=j.Combat,q.screenAnimStart=a,q.screenAnimType="enemy",q.inCombat=!0}function Q(e,t){switch(q.screenAnimType){case"enemy":{const a=(t-250-q.screenAnimStart)/750;if(a>1)return;const r=Math.max(Math.min(a,.25),0)/.25*80.1,s=Math.max(Math.min(a-.25,.25),0)/.25*80.1,n=Math.max(Math.min(a-.5,.25),0)/.25*80.1,i=Math.max(Math.min(a-.75,.25),0)/.25*80.1;e.fillRect("#b43",80,r,80.1,80.1-r),e.fillRect("#b43",80,80,80.1-s,80.1),e.fillRect("#b43",0,80,80.1,80.1-n),e.fillRect("#b43",i,0,80.1-i,80.1);break}case"weather":{const a=(t-2e3-q.screenAnimStart)/1e3;if(a>1)return;const r=Math.max(Math.min(a,1),0)/1;e.fillRect(`rgba(1.0, 1.0, 1.0, ${1-r})`,0,0,160,160),e.drawText(80-q.weather.length/2*9,71,q.weather)}case"intro":{const a=(t-9e3-1e3-q.screenAnimStart)/1500;if(a>1)return;const r=255*(1-Math.max(Math.min(a,1),0)/1),s=a<-1?0:1;e.fillRect(`rgba(${r}, ${r}, ${r}, ${s})`,0,0,80,80)}}}addEventListener("keydown",(e=>{let t=q.state===j.Combat?q.combatMenu:q.currentMenu;t.inputMode&&(1===e.key.length&&t.input.length<17&&(t.input+=e.key),"Backspace"===e.key&&(t.input=t.input.slice(0,-1)))}));const V=new class{constructor(e){this.canvas=document.getElementById(e),this.context=canvas.getContext("2d"),this.size=0,this.scale=0,this.images=new Map,this.anims=new Map,addEventListener("resize",(()=>this.resize())),this.resize()}async loadImages(e){const t=[];for(let a=0;a<e.length;++a)t.push(new Promise((t=>{this.images.set(e[a],new Image),this.images.get(e[a]).src=`assets/${e[a]}.png`,this.images.get(e[a]).onload=()=>{t()}})));return Promise.all(t)}async loadAnim(e,t){const a=[];for(let r=0;r<t;++r)a.push(e+(r+1));return this.anims.set(e,t),this.loadImages(a)}fill(e){this.context.fillStyle=e,this.context.fillRect(0,0,this.canvas.width,this.canvas.height)}fillRect(e,t,a,r,s){this.context.fillStyle=e,this.context.fillRect(t*this.scale,a*this.scale,r*this.scale,s*this.scale)}draw(e,t,a,r,s,n,i){this.context.drawImage(this.images.get(e),t,a,r,s,n*this.scale,i*this.scale,r*this.scale,s*this.scale)}drawAnim(e,t,a,r,s,n,i,o,c){const l=Math.floor(o*c%this.anims.get(e))+1;this.draw(e+l,t,a,r,s,n,i)}drawText(e,t,a){if(void 0===this.images.get("font"))return new Error("Must load font.png to draw text");for(let r=0;r<a.length;++r){const s=a.charCodeAt(r),n={x:s%16,y:Math.floor(s/16)};this.context.drawImage(this.images.get("font"),9*n.x,9*n.y,9,9,(e+9*r)*this.scale,t*this.scale,9*this.scale,9*this.scale)}}resize(){this.size=innerWidth<innerHeight?innerWidth:innerHeight,this.scale=this.size/160,this.canvas.width=this.size,this.canvas.height=this.size,this.context.imageSmoothingEnabled=!1}}("canvas"),X=new class{constructor(){this.keys={up:!1,down:!1,enter:!1},addEventListener("keydown",(e=>this.handleEvent(e)))}flush(){this.keys.up=!1,this.keys.down=!1,this.keys.enter=!1}handleEvent(e){switch(e.key){case"ArrowUp":this.keys.up="keydown"===e.type;break;case"ArrowDown":this.keys.down="keydown"===e.type;break;case"Enter":this.keys.enter="keydown"===e.type}}};function Z(e=0){!function(e,r,s){if(q.time=e,q.client.pollIncomingPackets((a=>{const r=a.readNumber();switch(console.log(r),r){case 1:if(q.isHost){const e=(new t).writeNumber(100);w.forEach(((t,a)=>{l[t].players.forEach((t=>{e.writeNumber(a).writeNumber(t)}))})),e.writeNumber(-1),q.client.sendPacket(e)}break;case 3:{const e=a.readNumber(),t=a.readNumber(),r=y[t];e===q.partyLeader&&(q.state=j.Location,q.currentLocation=r,q.currentMenu=Y[r]),u(e,r);break}case 4:{const e=a.readNumber();e===q.partyLeader&&(q.state=j.Map),h(e);break}case 5:if(m(a.readNumber())===q.currentLocation){const e=a.readString();q.currentMenu.talk(e)}break;case 6:{const e=a.readString();if(q.partyPassword===e){const e=a.readNumber();if(m(e)!==q.currentLocation)break;if(e>-1&&!q.party.includes(e)){const r=a.readNumber(),s=a.readNumber();if(q.isPartyLeader){q.partyIndividualHealth[e]={maxHealth:r,health:s};const a=(new t).writeNumber(8).writeNumber(e).writeNumber(q.maxHealth).writeNumber(q.health);q.party.forEach((e=>a.writeNumber(e))),a.writeNumber(-1),q.client.sendPacket(a)}q.maxHealth+=r,q.health+=s,q.party.push(e),q.currentMenu.talk("Member joined"),q.currentMenu.talk("party")}}break}case 7:{const e=a.readString();if(q.partyPassword===e){const a=(new t).writeNumber(11).writeString(e);q.client.sendPacket(a)}break}case 8:{const e=a.readNumber();if(q.id===e){q.partyPassword=q.waitingPartyPassword;const e=a.readNumber(),t=a.readNumber();q.individualHealth=q.health,q.individualMaxHealth=q.maxHealth,q.maxHealth+=e,q.health+=t;const r=a.readNumber();for(q.partyLeader=r,q.party.push(r);;){const e=a.readNumber();if(-1===e)break;q.party.push(e)}q.currentMenu.talk("Joined Party")}break}case 9:{const e=a.readNumber();if(q.party.includes(e)){const t=a.readNumber(),r=(a.readNumber(),q.health/q.maxHealth),s=Math.floor(r*t);q.maxHealth-=t,q.health-=s,q.party=q.party.filter((t=>e!==t)),q.currentMenu.talk("Member left party")}break}case 10:if(a.readNumber()===q.partyLeader){const e=a.readNumber();q.partyLeader=e,q.isPartyLeader=e===q.id,q.currentMenu.talk("You are now"),q.currentMenu.talk("party leader")}break;case 11:a.readString()===q.partyPassword&&(q.currentMenu.talk("Password in use"),q.currentMenu.talk("Try /join or make"),q.currentMenu.talk("another"),q.partyPassword="",q.isPartyLeader=!1,q.partyLeader=-1);break;case 12:if(a.readNumber()===q.partyLeader){const e=a.readNumber();"talk"===q.currentMenu.current&&q.currentMenu.select(q,q.currentMenu.root),q.currentMenu.index=e,q.currentMenu.select(q)}break;case 13:if(a.readNumber()===q.partyLeader&&!q.isPartyLeader){const t=a.readNumber();K(o[t],e)}break;case 14:if(a.readNumber()===q.partyLeader){const e=a.readString(),t=a.readNumber(),r=a.readNumber();q.attackSelection.push({...b[S[t]],server:!0,username:e,damage:r,type:"attack"})}break;case 15:if(a.readNumber()===q.partyLeader&&!q.isPartyLeader){const e=a.readNumber(),t=a.readNumber();q.attackSelection.push({...q.enemy,...q.enemy.attacks[e],attackId:e,damage:t,type:"enemy"})}break;case 100:for(;;){const e=a.readNumber();if(-1===e)break;u(a.readNumber(),y[e])}break;case 200:q.currentLocation=null,q.currentMenu=L;break;case 201:q.state=j.Location,q.currentMenu.select(q,"title"),q.currentMenu.messages=["That host ID","doesn't exist"];break;case 202:console.log("player left");const r=a.readNumber();if(q.party.includes(r))if(q.isPartyLeader){const e=q.partyIndividualHealth[r].maxHealth,a=q.partyIndividualHealth[r].health,s=q.health/q.maxHealth,n=Math.floor(s*e);q.maxHealth-=e,q.health-=n,q.party=q.party.filter((e=>r!==e));const i=(new t).writeNumber(9).writeNumber(r).writeNumber(e).writeNumber(a);q.client.sendPacket(i)}else q.partyLeader===r&&(q.currentMenu.talk("Party disbanded:"),q.currentMenu.talk("Leader left"),q.partyLeader=-1,q.partyPassword="",q.party=[q.id]);h(r);break;case 203:q.id=a.readNumber(),q.party.unshift(q.id),console.log("Received User ID: "+q.id),q.isHost&&setInterval((()=>{q.changeRequest=!0}),3e5);break;case 204:q.state=j.Location,q.currentMenu.select(q,"title"),q.currentMenu.messages=["That host ID","already exists"]}console.log(q.health,q.maxHealth,q.individualHealth,q.individualMaxHealth)})),q.state===j.Intro)return q.state=j.Location,q.currentMenu=P,q.screenAnimType="intro",r.fillRect("#000",0,0,160,160),r.drawAnim("intro",0,0,80,80,0,0,e-q.screenAnimStart,.005),Q(r,e),r.drawText(30,106,"You have to"),r.drawText(39,119,"stop  him"),void(e-q.screenAnimStart>11400&&(q.state=j.Location,q.currentMenu=P,q.currentMenu.messages=["You snap awake","unaware of your","surroundings. Was","that a dream?"]));if(s.keys.down&&(q.state===j.Map?q.locationSelected=(q.locationSelected+1)%d[q.currentLocation].length:q.state===j.Combat?q.combatMenu.moveDown():q.currentMenu.moveDown()),s.keys.up&&(q.state===j.Map?(q.locationSelected=(q.locationSelected-1)%d[q.currentLocation].length,q.locationSelected<0&&(q.locationSelected+=d[q.currentLocation].length)):q.state===j.Combat?q.combatMenu.moveUp():q.currentMenu.moveUp()),s.keys.enter)if(q.state!==j.Map||0!==q.partyPassword.length&&!q.isPartyLeader){if(q.state===j.Combat)q.combatMenu.select(q);else if(q.isOffline||0===q.partyPassword.length||q.currentMenu.freeRoam||"talk"===q.currentMenu.current||"talk"===q.currentMenu.currentOptions()[q.currentMenu.index].to)q.currentMenu.select(q);else if(q.isPartyLeader){const e=q.currentMenu.index,a=(new t).writeNumber(12).writeNumber(q.id).writeNumber(e);q.client.sendPacket(a),q.currentMenu.select(q)}}else{const t=d[q.currentLocation];if(q.currentLocation===t[q.locationSelected])q.locationSelected=0,q.state=j.Location;else if(q.currentMenu.talking=[],t[q.locationSelected]===c.Ice&&"winter"!==q.weather)alert("Cannot move here");else if(t[q.locationSelected]===c.ForestN&&q.currentLocation===c.ForestS||t[q.locationSelected]===c.ForestS&&q.currentLocation===c.ForestN)alert("The river is too strong to pass");else if(q.currentLocation=t[q.locationSelected],q.currentLocation!==c.CityLg&&q.currentLocation!==c.CityMd&&q.currentLocation!==c.CitySm||(q.lastCity=q.currentLocation),q.currentMenu=Y[q.currentLocation],q.locationSelected=0,Math.random()<-1&&q.currentLocation!==c.Start&&q.currentLocation!==c.Dummies&&q.currentLocation!==c.TutPort){switch(q.currentLocation){case c.CrossRoad:case c.Statue:case c.ForestN:case c.ForestS:}K(a.SandFlea,e)}else q.state=j.Location}if(q.isOffline||(q.state===j.Map&&q.inLocation?(q.inLocation=!1,q.client.sendPacket((new t).writeNumber(4).writeNumber(q.id)),h(q.id)):q.state===j.Location&&!1===q.inLocation&&null!==q.currentLocation&&(q.inLocation=!0,q.client.sendPacket((new t).writeNumber(3).writeNumber(q.id).writeNumber(p[q.currentLocation])),u(q.id,q.currentLocation),q.currentMenu.reset())),q.changeRequest&&(q.changeRequest=!1,q.state===j.Map&&(q.screenAnimStart=e,q.screenAnimType="weather","Summer"===q.weather?q.weather="Rainy":"Rainy"===q.weather?q.weather="Winter":"Winter"===q.weather&&(q.weather="Summer"))),q.inCombat){if((q.isPartyLeader||0===q.partyPassword.length)&&0===q.attackSelection.length){const e=q.enemy,a=Math.floor(Math.random()*e.attacks.length),r=e.attacks[a];let s=0===r.damage?0:r.damage+(Math.floor(3*Math.random())-1);const n={enemyId:i[e.name],attackId:a,damage:s,type:"enemy"};q.attackSelection.push({...q.enemy,...r,...n});const o=(new t).writeNumber(15).writeNumber(q.id).writeNumber(a).writeNumber(s);q.client.sendPacket(o)}q.attackSelection.length>q.party.length&&(q.attackSelection.sort(((e,t)=>t.speed===e.speed?void 0===t.username?-1:void 0===e.username?1:t.username-e.username:t.speed-e.speed)),q.attackSelection.forEach((e=>{if(!(q.enemy.health<=0||q.health<=0))switch(e.type){case"enemy":q.health-=e.damage,e.flavour.forEach((t=>q.combatMenu.talk(t.replace("%",e.damage))));break;case"attack":{let t=e.damage;e.heal?(q.health+=t,q.health>q.maxHealth&&(q.health=q.maxHealth)):q.enemy.health-=t;const a=q.username===e.username?"You":e.username;a.length<6?e.heal?(q.combatMenu.talk(`${a}`),q.combatMenu.talk(`healed ${t} dmg`)):q.combatMenu.talk(`${a} did ${t} dmg`):e.heal?(q.combatMenu.talk(e.username),q.combatMenu.talk(`healed ${t} dmg`)):(q.combatMenu.talk(e.username),q.combatMenu.talk(`did ${t} dmg`));break}}})),q.combatMenu.select(q,"combat"),q.attackSelection=[]),q.enemy.health<=0?(q.enemy.health=0,q.inCombat=!1,q.gold+=q.enemy.gold,q.combatMenu.select(q,"win")):q.health<=0&&(q.health=0,q.inCombat=!1,q.gold=0,q.combatMenu.select(q,"lose"))}switch(r.fill("#000"),q.state){case j.Location:J(r,e,q.currentMenu);break;case j.Combat:J(r,e,q.combatMenu),r.fillRect("#111",0,0,80,10),r.fillRect("#f00",1,1,q.enemy.health/q.enemy.maxHealth*78,8),r.drawText(1,0,`${q.enemy.health}/${q.enemy.maxHealth}`),r.fillRect("#111",0,70,80,10),r.fillRect("#16C604",1,71,q.health/q.maxHealth*78,8),r.drawText(1,70,`${q.health}/${q.maxHealth}`),Q(r,e);break;case j.Map:{q.mapTutorial&&(q.mapTutorial=!1,setTimeout((()=>{alert("-- Epic Tutorial Below --\nThat impossible to see guy at the bottom left is you.\nThe red circle is where you want to go. Use Up/Down arrows to move it around and push enter when you are ready.\n\nP.S. Bunch of information added to the itch.io page that I couldn't tutorialise")}),50)),r.drawAnim("map_base",0,0,160,160,0,0,e,5e-4),r.drawAnim("map_deco",0,0,160,160,0,0,e,.005),"Summer"===q.weather?r.drawAnim("map_river",0,0,160,160,0,0,e,.004):"Rainy"===q.weather?(r.draw("map_snow",0,0,160,160,0,0),r.drawAnim("map_river",0,0,160,160,0,0,e,.004),r.drawAnim("map_rain",0,0,160,160,0,0,e,5e-4)):"Winter"===q.weather&&(r.draw("map_mtnsnow",0,0,160,160,0,0),r.draw("map_snow",0,0,160,160,0,0),r.draw("map_ice",0,0,160,160,0,0));const t=d[q.currentLocation];r.draw("spritesheet",0,9,9,9,l[q.currentLocation].position[0],l[q.currentLocation].position[1]);const a=l[t[q.locationSelected]];r.draw("spritesheet",0,0,9,9,a.position[0],a.position[1]),Q(r,e);break}}s.flush()}(e,V,X),requestAnimationFrame((e=>{Z(e)}))}!async function(){await Promise.all([V.loadImages(["font","console","other","spritesheet","map_mtnsnow","map_snow","map_ice","start","dummies","tutport","citylg","crossroads","statue","citymd","citysm","forests","forestn","tundras","tundran","ice","dungeon","tower","grasslands","cave","campfire","trees","sandflea","dummy"]),V.loadAnim("intro",45),V.loadAnim("title",8),V.loadAnim("map_base",3),V.loadAnim("map_deco",3),V.loadAnim("map_river",3),V.loadAnim("map_rain",2)]),Z()}()})();